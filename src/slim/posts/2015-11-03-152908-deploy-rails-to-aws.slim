.meta-data title Deploy railsåˆ°aws
.meta-data datetime 2015-11-03 15:29:08
.meta-data tags rails,rails_deploy
.meta-data category coding
.meta-data link deploy-rails-to-aws
.meta-data file 2015-11-03-152908-deploy-rails-to-aws
.meta-data template post
.meta-data end

h1 åœ¨AWSé–‹ä¸€å€‹EC2

h2
  | åˆ°Amazon Web Services > EC2 > EC2 Dashboard > Launch Instance
h2
  | å»ºç«‹ä¸€å€‹EC2
ul
  li
    | Step1: é¸AMIï¼š Amazon Linux AMI 2015.09.1 (HVM), SSD Volume Type 
  li
    | Step2: é¸Instance Type
  li
    | Step3: è¨­å®šInstance
  li
    | Step4: è¨­å®šStorage
  li
    | Step5: è¨­å®šTag
  li
    | Step6: è¨­å®šSecurityGroupï¼š Create a new security group > å‘½åname(ä¾‹å¦‚ï¼štest-app-group)ï¼ŒåŠ ä¸€å€‹æ–°çš„rule(HTTP/TCP/80/Anywhere)ã€‚
  li
    | Create a new key pair > å‘½å test_app_key > Download Key Pair
  li
    | Review and Launch > Launch
h2
  | è¨­å®šEC2èˆ‡Elastic IPs
ul
  li
    | EC2 > Instances > é¸å–å‰›å‰›å»ºç«‹çš„instance
  li
    | ä¸‹é¢æœƒå‡ºç¾instanceç›¸é—œçš„è³‡è¨Šï¼Œé‡è¦çš„å…©å€‹è³‡è¨Šæ˜¯ Public DNS èˆ‡ Public IPã€‚
  li
    | EC2 > Elastic IPs
  li
    | Allocate New Address > Allocate
  li
    | é¸å–å‰›å‰›å»ºç«‹çš„EIPï¼ŒActions > Associate Address > é¸å–å‰›å‰›å»ºç«‹çš„instance
  li
    | å›åˆ° Instancesï¼Œå‰›å‰›å»ºç«‹çš„instanceçš„ Elastic IP æœƒå‡ºç¾ï¼Œè€Œ Public IP ä¹Ÿæœƒè¢«æ”¹æˆè·Ÿ Elastic IP ä¸€æ¨£ï¼Œé€™ä¹Ÿæ˜¯æœ€çµ‚é€£ç·šåˆ°é€™å€‹instanceç”¨çš„å°å¤–IP(ä¾‹å¦‚ï¼š53.11.132.42)ã€‚
h2
  | sshè‡³EC2
ul
  li
    | åˆ°æœ¬æ©Ÿç«¯ï¼Œå°‡å‰›å‰›ä¸‹è¼‰çš„ test_app_key.pem æ”¾åˆ° ~/.ssh
  li
    | æ›´æ”¹keyçš„å­˜å–æ¬Šé™
pre
  code
    | $ chmod 600 ~/.ssh/test_app_key.pem
ul
  li
    | é€£ç·šè‡³EC2
pre
  code
    | $ ssh ec2-user@53.11.132.42 -i ~/.ssh/test_app_key.pem
      The authenticity of host '53.11.132.42 (53.11.132.42)' can't be established.
      RSA key fingerprint is ca:32:e4:cb:3b:dc:51:27:27:9b:c4:d8:39:f0:24:6a.
      Are you sure you want to continue connecting (yes/no)? yes
      
       __|  __|_  )
      _|  (     /   Amazon Linux AMI
      ___|\___|___|

      https://aws.amazon.com/amazon-linux-ami/2015.09-release-notes/
      [ec2-user@ip-172-32-26-98 ~]$ 
p
  | çœ‹åˆ°ä¸Šé¢çš„ç•«é¢è¡¨ç¤ºä½ å·²ç¶“æˆåŠŸçš„é€£ç·šè‡³EC2ã€‚
  

h1 å»ºç«‹RDS
h2
  | åˆ°Amazon Web Services > RDS > RDS Dashboard > Launch Instance
h2
  | å»ºç«‹ä¸€å€‹mysql RDS
ul
  li
    | Step1: Select Engine - MySQL > Select
  li 
    | Step2: Choose database type > Yes/No
  li 
    | Step3: Specify DB Details > è¨­å®š DB Instance Identifier(instanceçš„åç¨±ï¼Œä¾‹å¦‚ï¼štest-app) / Master Username(mysqlçš„ç®¡ç†æ¬Šé™å¸³è™Ÿï¼Œä¾‹å¦‚ï¼šmysqluser)) / Master Password
  li 
    | Step4: Configure Advanced Settings > VPC Security Group(å¯ä»¥å…ˆé¸defaultï¼Œä¹‹å¾Œå¯ä»¥æ”¹æ‰) / Database Name(è®“å®ƒæ˜¯ç©ºçš„ï¼Œä¹‹å¾Œå¯ä»¥è‡ªå·±å»º) / Port(mysqlé€£ç·šç”¨çš„portï¼Œä¾‹å¦‚ï¼š5678) 
  li
    | Launch
  li
    | åˆ°RDS Dashboardä¸Šå¯ä»¥çœ‹åˆ°DBçš„instanceæ­£åœ¨å»ºç«‹ï¼Œé»é¸instanceä¹‹å¾Œï¼Œä¸‹æ–¹æœƒå‡ºç¾DBçš„ç´°ç¯€ï¼Œå…¶ä¸­Endpointå°±æ˜¯é€£ç·šçš„hostèˆ‡port(test-app.jfkwohjdwioj8.us-west-2.rds.amazonaws.com:5678)ã€‚
h2
  | è¨­å®š Security Group è®“EC2å¯ä»¥é€£ç·š
ul
  li
    | EC2 > Security Group > Create Security Group
  li
    | è¨­å®š Security Group name(ä¾‹å¦‚ï¼štest-app-db) / Description / VPC(é¸é è¨­çš„)
  li
    | åœ¨ Inbound åŠ ä¸Šä¸€å€‹æ–°çš„è¨­å®š(Custom TCP Rule/TCP/5678/CustomIP[é¸EC2 instanceæ‰€åœ¨çš„security group])
  li 
    | å°‡æ–°å»ºç«‹RDSçš„Security Groupæ”¹æˆtest-app-group
h2
  | åœ¨EC2ä¸Šå®‰è£é€£ç·šRDS mysqlè³‡æ–™åº«æœƒç”¨åˆ°çš„package
ul
  li
    | ä½¿ç”¨ec2-useré€£ç·šè‡³serverã€‚
  li
    | å®‰è£mysqlæœƒç”¨åˆ°çš„packageã€‚
pre
  code
    | $ sudo yum install mysql
ul
  li
    | ä½¿ç”¨mysqlé€£ç·šè‡³RDSï¼Œçœ‹åˆ°ä¸‹é¢çš„ç•«é¢å°±è¡¨ç¤ºé€£ç·šæˆåŠŸäº†ã€‚
pre
  code
    | $ mysql -P 5678 -h test-app.jfkwohjdwioj8.us-west-2.rds.amazonaws.com -u mysqluser -p
      Enter password: 
      Welcome to the MySQL monitor.  Commands end with ; or \g.
      Your MySQL connection id is 20
      Server version: 5.6.23-log MySQL Community Server (GPL)

      Copyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.

      Oracle is a registered trademark of Oracle Corporation and/or its
      affiliates. Other names may be trademarks of their respective
      owners.

      Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
      
      mysql> 
h2
  | å»ºç«‹ä¸€å€‹é€£ç·šç”¨çš„mysqlå¸³è™Ÿèˆ‡ç¶²ç«™æ‰€éœ€è¦çš„è³‡æ–™åº«
p 
  | ç†è«–ä¸Šmysqlçš„ç®¡ç†å¸³è™Ÿä¸æ‡‰è©²æ‹¿ä¾†åšç‚ºå¹³å¸¸é€£ç·šä¹‹ç”¨ï¼Œæ‰€ä»¥æˆ‘å€‘æœƒé–‹å¦ä¸€å€‹å¸³è™Ÿä¸¦è¨­å®šæ¯”è¼ƒä½çš„æ¬Šé™ã€‚é€™æ™‚å€™æˆ‘å€‘è¦æ±ºå®šå¹¾å€‹æ±è¥¿ï¼šé€£ç·šå¸³è™Ÿ(ä¾‹å¦‚ï¼štest_app_user)ã€å¸³è™Ÿå¯†ç¢¼(ä¾‹å¦‚ï¼štest_app_pw)èˆ‡è³‡æ–™åº«çš„åç¨±(ä¾‹å¦‚ï¼štest_app_db)ã€‚å¦å¤–æˆ‘å€‘ä¹Ÿå¯ä»¥é †ä¾¿å»ºç«‹ç¶²ç«™æ‰€éœ€è¦çš„è³‡æ–™åº«ï¼Œé›–ç„¶ä¹Ÿå¯ä»¥ç”¨railsçš„rake db:createä¾†å»ºï¼Œä¸éé‚„è¦ä¸‹è¼‰repoå¯¦åœ¨æœ‰é»éº»ç…©ï¼Œæ‰€ä»¥é€™é‚Šå°±ç›´æ¥ä¸‹æŒ‡ä»¤ä¾†å»ºdbå˜ã€‚
ul
  li
    | ä½¿ç”¨mysqlé€£ç·šè‡³RDSã€‚
  li 
    | å»ºç«‹ä¸€å€‹å¸³è™Ÿä¸¦è¨­å®šæ¬Šé™ã€‚
pre
  code
    | CREATE USER 'test_app_user'@'%' IDENTIFIED BY 'test_app_pw';
      GRANT ALL PRIVILEGES ON 'test_app_db' . * TO 'test_app_user'@'%';
      FLUSH PRIVILEGES;
ul
  li
    | å»ºç«‹è³‡æ–™åº«ã€‚
pre
  code
    | CREATE DATABASE IF NOT EXISTS test_app_db DEFAULT CHARACTER SET = 'utf8' DEFAULT COLLATE 'utf8_general_ci';
ul
  li
    | ç™»å‡ºmysqlå¾Œï¼Œæˆ‘å€‘å¯ä»¥å°±ä½¿ç”¨test_app_userä¾†é€£ç·šäº†ã€‚
pre
  code
    | $ mysql -P 5678 -h test-app.jfkwohjdwioj8.us-west-2.rds.amazonaws.com -u test_app_user -p

h1 è¨­å®šserver

h2
  | ä½¿ç”¨ec2-useré€£ç·šè‡³serverï¼Œæ›´æ–° package
pre
  code
    | $ sudo yum update
      Loaded plugins: priorities, update-motd, upgrade-helper
      No packages marked for update
h2
  | å»ºç«‹ä¸€å€‹æ–°user - appuser
p
  | appuseræœƒå…·æœ‰sudoæ¬Šé™æ“ä½œserverï¼Œç”¨ä¾†å–ä»£rootèˆ‡ec2-userã€‚
ul
  li
    | å»ºç«‹ä¸€å€‹æ–°userï¼Œä¸¦è¨­å®šå¯†ç¢¼
pre
  code
    | $ sudo adduser appuser
      $ sudo passwd appuser
ul
  li
    | ç·¨è¼¯sudoåå–®ï¼Œè®“appuseræ“æœ‰sudoæ¬Šé™
pre
  code
    | $ sudo visudo
      # ...
      root    ALL=(ALL)       ALL
      appuser ALL=(ALL)       ALL
      # ...
ul
  li
    | é‡æ–°é–‹æ©Ÿ sudo reboot
h2
  | ä½¿ç”¨appuseré€£ç·šè‡³server
p
  | åªè¦å°‡æœ¬åœ°ç«¯çš„ public key åŠ åˆ° appuser çš„ .ssh/authorized_keys å³å¯ã€‚
ul
  li
    | åœ¨æœ¬åœ°ç«¯æŸ¥çœ‹ ~/.ssh/id_rsa.pub æª”æ¡ˆ
  li
    | ä½¿ç”¨ec2-userç·šç·šåˆ°server
  li
    | åˆ‡æ›åˆ°appuser
pre
  code
    | $ sudo su - appuser
ul
  li
    | å»ºç«‹ .ssh ç›®éŒ„ï¼Œå°‡ ~/.ssh/id_rsa.pub æª”æ¡ˆåŠ åˆ° .ssh/authorized_keys ä¹‹ä¸­ã€‚
  li
    | æ›´æ–° .ssh èˆ‡ .ssh/authorized_keys çš„å­˜å–æ¬Šé™ã€‚
pre
  code
    | $ chmod 700 .ssh
      $ chmod 600 .ssh/authorized_keys
ul
  li
    | å›åˆ°æœ¬æ©Ÿç«¯ï¼Œå°±å¯ä»¥ä½¿ç”¨è‡ªå·±çš„keyä»¥appuserçš„å¸³è™Ÿç™»å…¥ã€‚
pre
  code
    | $ ssh appuser@53.11.132.42 -i ~/.ssh/id_rsa
h2
  | è¨­å®šsshï¼Œé—œé–‰root passwordç™»å…¥åŠŸèƒ½ï¼Œæ›´æ”¹é€£ç·šçš„port
ul
  li
    | ç™»å…¥server
  li
    | ç·¨è¼¯ /etc/ssh/sshd_configï¼Œè¨­å®šä¸‹é¢çš„è¨­å®šå€¼
pre
  code
    | Port 1234
      PermitRootLogin no
      PasswordAuthentication no
      X11Forwarding no
      AllowUsers appuser
p
  | èªªæ˜ä¸€ä¸‹ï¼š
p
  | Port 1234ï¼šæ›´æ”¹sshé€£ç·šæ™‚çš„portç‚º1234ã€‚
p
  | PermitRootLogin noï¼šè¡¨ç¤ºä¸å…è¨±ä½¿ç”¨rooté€²è¡Œç™»å…¥ã€‚
p
  | PasswordAuthentication noï¼šè¡¨ç¤ºä¸èƒ½ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼çš„æ–¹å¼ç™»å…¥ã€‚
p
  | X11Forwarding noï¼šä¸ä½¿ç”¨X11 Forwardingï¼Œå› ç‚ºæˆ‘å€‘ä¸æœƒç”¨åˆ°åœ–å½¢ç•Œé¢ã€‚
p
  | AllowUsers appuserï¼šåªå…è¨± appuser å¯ä»¥sshé€£ç·šã€‚
ul
  li
    | é‡è®€sshè¨­å®š
pre
  code
    | $ sudo /etc/init.d/sshd reload
ul
  li
    | æ›´æ”¹aws instanceçš„security groupè¨­å®šï¼Œåˆ° EC2 > Security Groups > é»é¸test-app-group > ä¸‹é¢æœƒå‡ºç¾è¨­å®šç´°ç¯€ > Inbound > Edit > æ–°å¢ä¸€å€‹rule(Custom TCP Rule/TCP/1234/Anywhere)ï¼Œæ¥è‘—æŠŠSSHé€™å€‹ruleåˆªæ‰ã€‚
ul
  li
    | é€™æ™‚å€™è¦é€£ç·šåˆ°serverï¼Œå°±åªèƒ½é€é appuser é€™å€‹å¸³è™Ÿèˆ‡port 1234ä¾†é€²è¡Œé€£ç·šã€‚
pre
  code
    | $ ssh appuser@53.11.132.42 -i ~/.ssh/id_rsa -p 1234
h2
  | å»ºç«‹deployuser
p 
  | deployuseræ˜¯å°ˆé–€ç”¨ä¾†åšdeployç”¨çš„ï¼Œèˆ‡appuseræœ€å¤§çš„ä¸åŒæ˜¯ï¼Œappuserå…·æœ‰sudoæ¬Šé™ï¼Œè€Œdeployuserå‰‡æ²’æœ‰ã€‚æ‰€ä»¥ä»»ä½•å®‰è£çš„æµç¨‹ï¼Œæ‡‰è©²æ˜¯ç”±appuserä¾†åšï¼Œè€Œdeployæ˜¯ç”±deployuserä¾†åšã€‚
ul
  li
    | å»ºç«‹deployuserï¼Œä¸¦è¤‡åˆ¶appuserçš„é€£ç·šè¨­å®š
pre
  code
    | sudo adduser deployuser
    	sudo mkdir /home/deployuser/.ssh
    	sudo chown -R deployuser /home/deployuser/.ssh
    	sudo chgrp -R deployuser /home/deployuser/.ssh
    	sudo chmod -R 700 /home/deployuser/.ssh
    	
    	sudo cp .ssh/authorized_keys /home/deployuser/.ssh/authorized_keys
    	sudo chown deployuser /home/deployuser/.ssh/authorized_keys
    	sudo chgrp deployuser /home/deployuser/.ssh/authorized_keys
    	
      sudo usermod -a -G deployuser appuser
ul
  li
    | å°‡deployuseråŠ åˆ°sshçš„è¨­å®šæª”ï¼Œç·¨è¼¯ /etc/ssh/sshd_configï¼Œä¿®æ”¹ä¸‹é¢çš„è¨­å®šå€¼
pre
  code
    | AllowUsers appuser deployuser
ul
  li
    | é‡è®€sshè¨­å®š
pre
  code
    | $ sudo /etc/init.d/sshd reload
ul
  li
    | é€™æ™‚å€™å°±å¯ä»¥ä½¿ç”¨deployuseré€£ç·šåˆ°serverã€‚
pre
  code
    | $ ssh deployuser@53.11.132.42 -i ~/.ssh/id_rsa -p 1234
    
h1
  | å®‰è£rvmèˆ‡ruby
  
h2
  | å®‰è£rvm
p 
  | rvmçš„åŠŸèƒ½æ˜¯ç”¨ä¾†åˆ‡æ›rubyçš„ç‰ˆæœ¬ï¼Œåœ¨æ—¥å¾Œè¦å‡ç´šrubyæ™‚æœƒçœäº‹å¾ˆå¤šã€‚å¦å¤–æˆ‘å€‘æœƒä½¿ç”¨multi-userçš„æ¨¡å¼ä¾†å®‰è£ï¼Œä¹Ÿå°±æ˜¯rvmæ˜¯å®‰è£åœ¨ç³»çµ±ä¹‹ä¸‹ï¼Œæ‰€æœ‰çš„ä½¿ç”¨è€…ç”¨çš„éƒ½æ˜¯åŒä¸€å¥—rvmã€‚è¦æ³¨æ„çš„æ˜¯ï¼ŒåŸ·è¡Œä¸€èˆ¬çš„rvmæŒ‡ä»¤æ™‚ä¸éœ€è¦sudoæ¬Šé™ï¼Œä½†å¦‚æœè¦å®‰è£rubyï¼Œå°±å¿…é ˆè¦æœ‰sudoæ¬Šé™ã€‚
ul
  li
    | åŸ·è¡Œrvmå®‰è£æŒ‡ä»¤ï¼Œç¬¬ä¸€æ¬¡åŸ·è¡Œæœƒå¤±æ•—ï¼Œå®ƒæœƒæç¤ºè¦åŠ å…¥GPG signature
pre
  code
    | $ \curl -sSL https://get.rvm.io | sudo bash -s stable
      [sudo] password for appuser: 
      Downloading https://github.com/rvm/rvm/archive/1.26.11.tar.gz
      Downloading https://github.com/rvm/rvm/releases/download/1.26.11/1.26.11.tar.gz.asc
      gpg: directory `/root/.gnupg' created
      gpg: new configuration file `/root/.gnupg/gpg.conf' created
      gpg: WARNING: options in `/root/.gnupg/gpg.conf' are not yet active during this run
      gpg: keyring `/root/.gnupg/pubring.gpg' created
      gpg: Signature made Mon 30 Mar 2015 09:52:13 PM UTC using RSA key ID BF04FF17
      gpg: Can't check signature: No public key
      Warning, RVM 1.26.0 introduces signed releases and automated check of signatures when GPG software found.
      Assuming you trust Michal Papis import the mpapis public key (downloading the signatures).

      GPG signature verification failed for '/usr/local/rvm/archives/rvm-1.26.11.tgz' - 'https://github.com/rvm/rvm/releases/download/1.26.11/1.26.11.tar.gz.asc'!
      try downloading the signatures:

          sudo gpg2 --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3

      or if it fails:

          command curl -sSL https://rvm.io/mpapis.asc | sudo gpg2 --import -

      the key can be compared with:

          https://rvm.io/mpapis.asc
          https://keybase.io/mpapis
ul
  li
    | åŠ å…¥GPG signature
pre
  code
    | $ sudo gpg2 --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
      gpg: keyring `/root/.gnupg/secring.gpg' created
      gpg: requesting key D39DC0E3 from hkp server keys.gnupg.net
      gpg: /root/.gnupg/trustdb.gpg: trustdb created
      gpg: key D39DC0E3: public key "Michal Papis (RVM signing) <mpapis@gmail.com>" imported
      gpg: no ultimately trusted keys found
      gpg: Total number processed: 1
      gpg:               imported: 1  (RSA: 1)
ul
  li
    | åŸ·è¡Œrvmå®‰è£æŒ‡ä»¤
pre
  code
    | $ \curl -sSL https://get.rvm.io | sudo bash -s stable
      Downloading https://github.com/rvm/rvm/archive/1.26.11.tar.gz
      Downloading https://github.com/rvm/rvm/releases/download/1.26.11/1.26.11.tar.gz.asc
      gpg: Signature made Mon 30 Mar 2015 09:52:13 PM UTC using RSA key ID BF04FF17
      gpg: Good signature from "Michal Papis (RVM signing) <mpapis@gmail.com>" [unknown]
      gpg: WARNING: This key is not certified with a trusted signature!
      gpg:          There is no indication that the signature belongs to the owner.
      Primary key fingerprint: 409B 6B17 96C2 7546 2A17  0311 3804 BB82 D39D C0E3
           Subkey fingerprint: 62C9 E5F4 DA30 0D94 AC36  166B E206 C29F BF04 FF17
      GPG verified '/usr/local/rvm/archives/rvm-1.26.11.tgz'
      Creating group 'rvm'

      Installing RVM to /usr/local/rvm/
      Installation of RVM in /usr/local/rvm/ is almost complete:

        * First you need to add all users that will be using rvm to 'rvm' group,
          and logout - login again, anyone using rvm will be operating with `umask u=rwx,g=rwx,o=rx`.

        * To start using RVM you need to run `source /etc/profile.d/rvm.sh`
          in all your open shell windows, in rare cases you need to reopen all shell windows.

      # appuser,
      #
      #   Thank you for using RVM!
      #   We sincerely hope that RVM helps to make your life easier and more enjoyable!!!
      #
      # ~Wayne, Michal & team.

      In case of problems: http://rvm.io/help and https://twitter.com/rvm_io
ul
  li
    | å°‡appuseråŠ åˆ°rvmçš„groupï¼Œè®“appuserå¯ä»¥åŸ·è¡Œrvm getç­‰ç›¸é—œçš„æŒ‡ä»¤ã€‚
pre
  code
    | sudo usermod -a -G rvm appuser
ul
  li
    | ç™»å‡ºå†ç™»å…¥å¾Œï¼Œå°±å¯ä»¥ä½¿ç”¨rvmçš„æŒ‡ä»¤ã€‚
pre
  code
    | $ rvm -v
      rvm 1.26.11 (latest) by Wayne E. Seguin <wayneeseguin@gmail.com>, Michal Papis <mpapis@gmail.com> [https://rvm.io/]
h2
  | å®‰è£ruby
ul
  li
    | å–å¾—æœ€æ–°çš„rvmèˆ‡rubyåˆ—è¡¨
pre
  code
    | $ rvmsudo rvm get stable
      Downloading https://get.rvm.io
      Downloading https://raw.githubusercontent.com/wayneeseguin/rvm/master/binscripts/rvm-installer.asc
      Verifying /usr/local/rvm/archives/rvm-installer.asc
      gpg: Signature made Tue 14 Apr 2015 12:05:41 AM UTC using RSA key ID BF04FF17
      gpg: Good signature from "Michal Papis (RVM signing) <mpapis@gmail.com>" [unknown]
      gpg: WARNING: This key is not certified with a trusted signature!
      gpg:          There is no indication that the signature belongs to the owner.
      Primary key fingerprint: 409B 6B17 96C2 7546 2A17  0311 3804 BB82 D39D C0E3
           Subkey fingerprint: 62C9 E5F4 DA30 0D94 AC36  166B E206 C29F BF04 FF17
      GPG verified '/usr/local/rvm/archives/rvm-installer'
      Downloading https://github.com/rvm/rvm/archive/1.26.11.tar.gz
      Downloading https://github.com/rvm/rvm/releases/download/1.26.11/1.26.11.tar.gz.asc
      gpg: Signature made Mon 30 Mar 2015 09:52:13 PM UTC using RSA key ID BF04FF17
      gpg: Good signature from "Michal Papis (RVM signing) <mpapis@gmail.com>" [unknown]
      gpg: WARNING: This key is not certified with a trusted signature!
      gpg:          There is no indication that the signature belongs to the owner.
      Primary key fingerprint: 409B 6B17 96C2 7546 2A17  0311 3804 BB82 D39D C0E3
           Subkey fingerprint: 62C9 E5F4 DA30 0D94 AC36  166B E206 C29F BF04 FF17
      GPG verified '/usr/local/rvm/archives/rvm-1.26.11.tgz'

      Upgrading the RVM installation in /usr/local/rvm/
      Upgrade of RVM in /usr/local/rvm/ is complete.

      # appuser,
      #
      #   Thank you for using RVM!
      #   We sincerely hope that RVM helps to make your life easier and more enjoyable!!!
      #
      # ~Wayne, Michal & team.

      In case of problems: http://rvm.io/help and https://twitter.com/rvm_io

      Upgrade Notes:

        * No new notes to display.

      RVM reloaded!
ul
  li
    | ä½¿ç”¨rvmå®‰è£ruby 2.2.3
pre
  code
    | $ rvmsudo rvm install 2.2.3
      Searching for binary rubies, this might take some time.
      No binary rubies available for: amazon/2015.09/x86_64/ruby-2.2.3.
      Continuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.
      Checking requirements for amazon.
      Installing requirements for amazon.
      Installing required packages: patch, libyaml-devel, glibc-headers, autoconf, gcc-c++, glibc-devel, patch, readline-devel, zlib-devel, libffi-devel, openssl-devel, automake, libtool, bison, sqlite-devel........................
      Requirements installation successful.
      Installing Ruby from source to: /usr/local/rvm/rubies/ruby-2.2.3, this may take a while depending on your cpu(s)...
      ruby-2.2.3 - #downloading ruby-2.2.3, this may take a while depending on your connection...
        % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                       Dload  Upload   Total   Spent    Left  Speed
      100 12.7M  100 12.7M    0     0  8096k      0  0:00:01  0:00:01 --:--:-- 8092k
      No checksum for downloaded archive, recording checksum in user configuration.
      ruby-2.2.3 - #extracting ruby-2.2.3 to /usr/local/rvm/src/ruby-2.2.3....
      ruby-2.2.3 - #configuring.........................................................
      ruby-2.2.3 - #post-configuration..
      ruby-2.2.3 - #compiling...............................................................................
      ruby-2.2.3 - #installing.............................
      ruby-2.2.3 - #making binaries executable..
      ruby-2.2.3 - #downloading rubygems-2.4.8
        % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                       Dload  Upload   Total   Spent    Left  Speed
      100  437k  100  437k    0     0   706k      0 --:--:-- --:--:-- --:--:--  707k
      No checksum for downloaded archive, recording checksum in user configuration.
      ruby-2.2.3 - #extracting rubygems-2.4.8....
      ruby-2.2.3 - #removing old rubygems.........
      ruby-2.2.3 - #installing rubygems-2.4.8......................
      ruby-2.2.3 - #gemset created /usr/local/rvm/gems/ruby-2.2.3@global
      ruby-2.2.3 - #importing gemset /usr/local/rvm/gemsets/global.gems...............................................
      ruby-2.2.3 - #generating global wrappers........
      ruby-2.2.3 - #gemset created /usr/local/rvm/gems/ruby-2.2.3
      ruby-2.2.3 - #importing gemsetfile /usr/local/rvm/gemsets/default.gems evaluated to empty gem list
      ruby-2.2.3 - #generating default wrappers........
      ruby-2.2.3 - #adjusting #shebangs for (gem irb erb ri rdoc testrb rake).
      Install of ruby-2.2.3 - #complete 
      Ruby was built without documentation, to build it run: rvm docs generate-ri
ul
  li
    | æŸ¥çœ‹rubyç‰ˆæœ¬
pre
  code
    | $ rvm ls

      rvm rubies
      
         ruby-2.2.3 [ x86_64 ]

    = "\n\n" + '# Default ruby not set. Try \'rvm alias create default <ruby>\'.' + "\n"
    | # => - current
      # =* - current && default
      #  * - default
ul
  li
    | è¨­å®šé è¨­rubyçš„ç‰ˆæœ¬è‡³2.2.3
pre
  code
    | $ rvm use 2.2.3 --default
      Using /usr/local/rvm/gems/ruby-2.2.3
ul
  li
    | å®‰è£bundler
pre
  code
    | $ gem install bundler --no-ri --no-rdoc
      Fetching: bundler-1.10.6.gem (100%)
      Successfully installed bundler-1.10.6
      1 gem installed

h1
  | è¨­å®šæ”¾ç½®ç¶²é çš„ç›®éŒ„èˆ‡å®‰è£nginx
ul
  li
    | ä½¿ç”¨appuserç™»å…¥åˆ°server
  li
    | å»ºç«‹æ”¾ç½®ç¶²é çš„ç›®éŒ„(/opt/www/test-app)ï¼Œä¸¦è¨­å®šç›®éŒ„åªæœ‰deployuserçš„å¸³è™Ÿæˆ–ç¾¤çµ„å¯ä»¥è®€å¯«é€™å€‹ç›®éŒ„çš„æ¬Šé™ã€‚
pre
  code
    | $ sudo mkdir -p /opt/www/test-app
      $ sudo chown -R deployuser /opt/www/test-app
      $ sudo chgrp -R deployuser /opt/www/test-app
      $ sudo chmod -R 775 /opt/www/test-app
ul
  li
    | å®‰è£nginx
pre
  code
    | sudo yum install nginx
ul
  li
    | è¨­å®šnginx
pre
  code
    | $ sudo mkdir /etc/nginx/sites-available
      $ sudo mkdir /etc/nginx/sites-enabled
p 
  | ä¸Šé¢çš„å‹•ä½œæœƒåœ¨/etc/nginxå»ºå…©å€‹ç›®éŒ„ï¼Œé€™éº¼åšçš„ç›®çš„æ˜¯æˆ‘å€‘æƒ³å°‡ä¸åŒçš„ç¶²ç«™è¨­å®šæª”åˆ†é–‹ï¼Œå°‡ç¶²ç«™ç›¸é—œçš„è¨­å®šæª”æ”¾åœ¨sites-availableä¹‹ä¸‹ï¼Œå¦‚æœè¦ä¸Šç·šï¼Œå°±å»ºä¸€å€‹linkåˆ°sites-enabledã€‚
ul
  li
    | ç·¨è¼¯/etc/nginx/nginx.confï¼Œåœ¨httpçš„blockä¸­include /etc/nginx/sites-enabledé€™å€‹ç›®éŒ„ã€‚
p 
  i
    | /etc/nginx/nginx.conf
pre
  code
    | http {
        # ...
        include /etc/nginx/sites-enabled/*;
        # ...
      }
ul
  li
    | åœ¨/etc/nginx/sites-availableä¸­å»ºç«‹ä¸€å€‹test_appçš„è¨­å®šæª”
p 
  i
    | /etc/nginx/sites-available/test_app
pre
  code
    | upstream unicorn_test_app {
      Â  server unix:/tmp/unicorn.test_app.sock fail_timeout=0;
      }

      server {
      Â  listen 80 default deferred;
      Â  server_name test-app.com;
      Â  root /opt/www/test-app/current/public;

      Â  location ~ ^/assets/ {
      Â  Â  gzip_static on;
      Â  Â  expires max;
      Â  Â  add_header Cache-Control public;
      Â  }

      Â  try_files $uri/index.html $uri @unicorn;
      Â  location @unicorn {
      Â  Â  proxy_set_header Host $http_host; Â 
      Â  Â  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      Â  Â  proxy_redirect off;
      Â  Â  proxy_pass http://unicorn_test_app;
      Â  }

      Â  error_page 500 502 503 504 /500.html;
      Â  client_max_body_size 4G;
      Â  keepalive_timeout 10;
      }
ul
  li
    | å»ºç«‹linkåˆ°site-enabledä¾†å•Ÿå‹•test_app
pre
  code
    | $ sudo ln -s /etc/nginx/sites-available/test_app /etc/nginx/sites-enabled/test_app
ul
  li 
    | é‡å•Ÿnginx
pre
  code
    | $ sudo service nginx start
h2
  | å®‰è£nodejsèˆ‡npm
p 
  | çœŸè¦‹é¬¼äº†ï¼Œyumçš„nodejsç‰ˆæœ¬ä¹Ÿå¤ªèˆŠäº†å§(0.10.36ï¼Œç¾åœ¨5.0.0éƒ½è¦å‡ºäº†è€¶)ï¼Œåªå¥½ç¡¬çš„é ­çš®è‡ªå·±è£äº†ã€‚é‚„å¥½æœ‰é€™ç¯‡å¯ä»¥åƒè€ƒï¼š
  a href="http://iconof.com/blog/how-to-install-setup-node-js-on-amazon-aws-ec2-complete-guide/#installNode" target="_blank"
    | How to install & setup Node.js on Amazon EC2 â€“ complete guide
ul
  li
    | ä½¿ç”¨appuserç™»å…¥serverã€‚
  li 
    | å®‰è£éœ€è¦ç”¨åˆ°çš„packageã€‚
pre
  code
    | $ sudo yum install gcc-c++ make openssl-devel
ul
  li
    | ä¸‹è¼‰nodejsçš„åŸå§‹æª”ã€ç·¨è­¯ä¸¦å®‰è£å®ƒã€‚
pre
  code
    | mkdir temp
      cd temp
      wget https://nodejs.org/dist/v4.2.2/node-v4.2.2.tar.gz
      tar -xf node-v4.2.2.tar.gz
      cd node-v4.2.2
      ./configure
      make
      sudo make install
ul
  li
    | å®‰è£å®Œä¹‹å¾Œç™»å‡ºå†ç™»å…¥ï¼Œå°±æœ‰nodeèˆ‡npmå¯ä»¥ç”¨äº†ã€‚
pre
  code
    | $ node -v
      v4.2.2
      $ npm -v
      2.14.7
h2
  | å®‰è£å…¶å®ƒæœƒç”¨åˆ°çš„package
p 
  | é€™è£¡å°±è·Ÿæ“šä½ çš„éœ€æ±‚å®‰è£éœ€è¦çš„packageï¼Œå¦‚æœå°‘å®‰è£äº†ï¼Œåœ¨deployåšbundle installçš„æ™‚å€™å°±æœƒå‡ºéŒ¯ï¼Œåˆ°æ™‚å€™å†å›ä¾†å®‰è£ä¹Ÿå¯ä»¥ã€‚é€™é‚Šåªè¨˜éŒ„æˆ‘è‡ªå·²æœ‰ç”¨åˆ°çš„package
ul
  li
    | ImageMagick - ç”¨ä¾†è™•ç†åœ–ç‰‡æª”æ¡ˆ
h2
  | åœ¨/opt/www/test-appä¸­åŠ å…¥deployæœƒç”¨åˆ°çš„æª”æ¡ˆ
p 
  | secrets.ymlèˆ‡database.ymlæ˜¯railsä¸­æœ€é‡è¦çš„å…©å€‹è¨­å®šæª”ï¼Œç†è«–ä¸Šé€™å…©å€‹æª”æ¡ˆéƒ½ä¸æ‡‰è©²commitåˆ°repoä¸­ã€‚åœ¨åšproduction deployçš„æ™‚å€™æœƒå¾/opt/www/test-app/shared/configçš„ç›®éŒ„ä¸­è¤‡è£½(ç²¾ç¢ºä¾†èªªæ˜¯å»ºç«‹link)åˆ°å¯¦éš›é‹ä½œçš„appç›®éŒ„ä¸­ï¼Œæ‰€ä»¥åœ¨deployä¹‹å‰ï¼Œæˆ‘å€‘è¦å…ˆåœ¨serverä¸Šå°æ‡‰çš„ç›®éŒ„ä¸‹æ‰‹å‹•å»ºç«‹é€™å…©å€‹æª”æ¡ˆã€‚
ul
  li 
    | ä½¿ç”¨deployuserç™»å…¥serverã€‚
  li
    | å»ºç«‹/opt/www/test-app/shared/configç›®éŒ„ï¼Œä¸¦å°‡productionçš„secrets.ymlèˆ‡database.ymlåŠ é€²å»ã€‚é€™è£¡çš„database.ymlæ‡‰è©²æœƒé•·çš„åƒä¸‹é¢é€™å€‹æ¨£å­
pre
  code
    | production:
        adapter: mysql2
        encoding: utf8
        pool: 5
        host: test-app.jfkwohjdwioj8.us-west-2.rds.amazonaws.com
        port: 5678
        database: test_app_db
        username: test_app_user
        password: test_app_pw
    
h1 åœ¨rails appä¸­è¨­å®šdeploy
h2
  | å®‰è£deployç”¨çš„gem
p 
  | å› ç‚ºæˆ‘å€‘æ˜¯ç”¨nginx + unicornï¼Œæ‰€ä»¥unicornæ˜¯ä¸€å®šè¦è£çš„ã€‚å¦å¤–æˆ‘å€‘æ˜¯ç”¨capistranoä¾†åšdeployï¼Œæ‰€ä»¥ä¸€äº›ç›¸é—œçš„gemä¹Ÿè¦åŠ é€²ä¾†ï¼Œä¸éæœƒæ”¾åœ¨developmentçš„groupä¸­ã€‚
pre
  code
    | # ...
      gem 'unicorn'
      # ...
      group :development do
        # ...
        gem 'capistrano-rails'
        gem 'capistrano-rvm'
        gem 'capistrano-npm'
        gem 'capistrano3-unicorn'
        # ...
      end
h2
  | è¨­å®šcapistrano
p 
  | capistranoæ˜¯å°ˆé–€åšdeployçš„å·¥å…·ï¼ŒåŸºæœ¬ä¸Šå®ƒçš„è¨­å®šæª”æ±ºå®šäº†æ•´å€‹deployçš„æµç¨‹ã€‚ä¸‹é¢æ˜¯ä¸€å€‹ç¯„ä¾‹ï¼š
p 
  i
    | config/deploy.rb
pre
  code
    | # config valid only for current version of Capistrano
      lock '3.4.0'

      set :application, 'app'
      set :repo_url, '[your repo]'
      set :user, 'deployuser'
      set :rails_env, 'production'
      set :assets_roles, [:app]
      set :npm_roles, [:app]
      set :unicorn_roles, [:app]

      set :ssh_options, { forward_agent: true, port: 1234 }
      set :deploy_to, '/opt/www/test-app'
      
      set :linked_files, fetch(:linked_files, []).push('config/database.yml', 'config/secrets.yml')
      set :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')

      set :npm_flags, '--silent --no-spin'

      namespace :deploy do
        after :restart, :clear_cache do
          on roles(:app), in: :groups, limit: 3, wait: 10 do
            # Here we can do anything such as:
            # within release_path do
            #   execute :rake, 'cache:clear'
            # end
          end
        end
        task :restart_unicorn do
          invoke 'unicorn:reload'
        end
        after :publishing, :restart_unicorn
      end
p 
  i
    | config/deploy/production.rb
pre
  code
    | role :app, %w{53.11.132.42}
      role :web,  %w{53.11.132.42}
      role :db,  %w{53.11.132.42}
h2
  | è¨­å®šunicorn
p 
  | unicornæ˜¯é€£æ¥web serverèˆ‡rails appçš„rack http serverã€‚æœ‰äº†capistrano3-unicornï¼Œæˆ‘å€‘å¯ä»¥åœ¨config/unicorn/[environment].rbä¸­åŠ ä¸Šunicornçš„è¨­å®šã€‚
p 
  i
    | config/unicorn/production.rb
pre
  code
    | root = "/opt/www/test-app/current"
      working_directory root
    = 'pid "#{root}/tmp/pids/unicorn.pid"' + "\n"
    = 'stderr_path "#{root}/log/unicorn.log"' + "\n"
    = 'stdout_path "#{root}/log/unicorn.log"' + "\n"
    = 'listen "/tmp/unicorn.test_app.sock"' + "\n"
    | worker_processes 1
      timeout 30
h2
  | é–‹å§‹deploy
ul
  li
    | cap production deploy
  li 
    | Good Luck
